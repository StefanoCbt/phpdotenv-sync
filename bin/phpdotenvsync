#!/usr/bin/env php
<?php

require_once __DIR__ . '/../vendor/autoload.php';

use Stefanocbt\PhpdotenvSync\Services\CliColoredMessagesService;
use Stefanocbt\PhpdotenvSync\OperationsStaticReference;
use Stefanocbt\PhpdotenvSync\Services\DotenvService;
use Stefanocbt\PhpdotenvSync\Services\OutputStringsService;
use Stefanocbt\PhpdotenvSync\Services\CommandExecutorService;

/**
 * Setting command arguments/options
 */
$longOpts = [
    'opt:', // required (the requested operation) (list operations: OperationsStaticReference.php)
    'src::', // optional (the dotenv file source)
    'dest::', // optional (the dotenv file destination)
];

$options = getopt(null, $longOpts);

/**
 * validating options
 */
if (empty($options)) {
    CliColoredMessagesService::danger('invalid options provided.');
    exit;
}
if (!in_array($options['opt'], OperationsStaticReference::OPT_DOTENV_REFERENCES)) {
    CliColoredMessagesService::danger('the requested opt does not exists.');
    exit;
}

/**
 * setting src & dest parameters
 */
$src = $_SERVER['PWD'] . '/.env.example';
$dest = $_SERVER['PWD'] . '/.env';
if (!empty($options['src'])) {
    $src = $options['src'];
}
if (!empty($options['dest'])) {
    $dest = $options['dest'];
}

/**
 * Running the requested opt
 */
$dotenvService = new DotenvService();

switch ($options['opt']) {
    case (OperationsStaticReference::OPT_DOTENV_CHECK_DIFF):
        /**
         * showing init infos
         */
        CliColoredMessagesService::success('Checking DIFF...');
        CliColoredMessagesService::info('src: ' . $src);
        CliColoredMessagesService::info('dest: ' . $dest);
        echo PHP_EOL;

        $diff = $dotenvService->getDotenvFilesDiff($src, $dest);

        if (empty($diff)) {
            CliColoredMessagesService::success('src and dest Dotenvs params are synced.');
            break;
        }

        /**
         * in this case the src Dotenv has more params than dest Dotenv
         */
        foreach ($diff as $missingParamName => $missingParamValue) {
            CliColoredMessagesService::warning('Missing param on dest Dotenv:');
            CliColoredMessagesService::info(OutputStringsService::getMissingDotenvParamString($missingParamName, $missingParamValue));

            echo PHP_EOL;
        }

        break;
    case (OperationsStaticReference::OPT_DOTENV_SYNC):
        /**
         * showing init infos
         */
        CliColoredMessagesService::success('Executing SYNC...');
        CliColoredMessagesService::info('src: ' . $src);
        CliColoredMessagesService::info('dest: ' . $dest);
        echo PHP_EOL;

        $diff = $dotenvService->getDotenvFilesDiff($src, $dest);

        if (empty($diff)) {
            CliColoredMessagesService::success('src and dest Dotenvs params are synced.');
            break;
        }

        /**
         * in this case the src Dotenv has more params than dest Dotenv
         */
        foreach ($diff as $missingParamName => $missingParamValue) {
            /**
             * asking action
             */
            $action = CommandExecutorService::askForDotenvParam($missingParamName, $missingParamValue);

            if (!$action || $action == CommandExecutorService::ASK_DOTENV_PARAM_ACTION_SKIP) {
                continue;
            }

            /**
             * handling action
             */
            switch ($action) {
                case (CommandExecutorService::ASK_DOTENV_PARAM_ACTION_COPY_DEFAULT_VALUE):
                    $dotenvService->addDotenvParam(
                        $missingParamName,
                        $missingParamValue,
                        $dest
                    );
                    CliColoredMessagesService::success('Added.');
                    break;
                case (CommandExecutorService::ASK_DOTENV_PARAM_ACTION_CHANGE_DEFAULT_VALUE):
                    $newValue = CommandExecutorService::askForNewDotenvValue();
                    $dotenvService->addDotenvParam(
                        $missingParamName,
                        $newValue,
                        $dest
                    );
                    CliColoredMessagesService::success('Added with specified value.');
                    break;
            }

            echo PHP_EOL;
        }

        echo PHP_EOL;
        CliColoredMessagesService::success('Sync completed.');
        break;
    default:
        CliColoredMessagesService::danger('the requested opt does not exists. (fail)');
        exit;
}
